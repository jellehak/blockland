<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Matrix Debugger</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
  </head>

  <body>
    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://cdn.socket.io/4.5.1/socket.io.js"></script>
    <!-- <script src="http://localhost:2002/socket.io/socket.io.js"></script> -->

    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
      }
    </script>

    <div id="app">
      <div>
        <h2>Utils</h2>
        <a target="_blank" href="https://admin.socket.io/#/events"
          >https://admin.socket.io/#/events</a
        >
      </div>

      <h2>State</h2>
      <div style="height: 400px; overflow: auto; overflow-y: scroll;">
        <pre>{{ remoteData }}</pre>
      </div>

      <h2>Events</h2>
      <div style="height: 400px; overflow: auto; overflow-y: scroll;">
        <!-- <pre>{{ events }}</pre> -->
        <div v-for="event in events">
          {{event}}
        </div>
      </div>
    </div>

    <script type="module">
      import { createApp } from "vue";

      createApp({
        data() {
          return {
            message: "Hello Vue!",
            events: [],
            remoteData: null,
            player: {
              model: "Housewife",
              colour: "Black",
              x: 0,
              y: 0,
              z: 0,
              h: 0,
              pb: 0,
            },
            others: {}
          };
        },
        async created() {
          // Socket
          {
            const socket = io.connect("http://localhost:2002", {
              transports: ["websocket"],
              'forceNew':true
            });

            // localStorage.debug = '*';
            // localStorage.debug = 'socket.io-client:socket'

            const state = {
              players: {},
            };

            socket.on("connect", () => {
              console.log(socket.id); // x8WIv7-mJelg7on_ALbx
              document.title = `Matrix (${socket.id})`
            });

            socket.on("connect_error", (err) => {
              // curl "https://localhost:2002/socket.io/?EIO=4&transport=polling"
              console.log(`connect_error due to ${err.message}`);
            });

            // Debug
            socket.onAny((event, message) => {
              // console.log(event, message);
              this.events.push({ event, message });
            });

            const game = this

            socket.on("setId", (data) => {
              this.id = data.id;
            });
            socket.on("remoteData", (data) => {
              game.remoteData = data;
            });

            const {player} = this

            // Create fake player
            socket.emit("init", player );

            // Send update
            setInterval(function() {
              player.x += 0.1

              const delta = {
                x: player.x.toFixed(2),
                y: player.y,
                z: player.z,
                h: player.h,
                pb: player.pb,
              }
              socket.emit("update", delta);
            }, 3000)

            // Expose
            window.socket = socket;
          }
        },
      }).mount("#app");
    </script>
  </body>
</html>
